# helm-base/templates/pv-pvc.yaml v1.0.0
# Template for PersistentVolume and PersistentVolumeClaim resources.
{{- if .Values.persistence.enabled }}
  {{- range .Values.persistence.storages }}
    {{- $storageName := .name }}
    {{- $secretName := .secretName }}

    {{- if .containers }}
      {{- $containerStorageClass := .containers.storageClass | default "azureblob-fuse-premium" }}
      {{- $releaseNamespace := $.Release.Namespace }}
      {{- range .containers.items }}
        {{- $item := dict "name" (print $.Values.name "-" $storageName "-" .name "-pv") "storageClassName" $containerStorageClass "type" "blob" "containerName" .name "secretName" $secretName "releaseNamespace" $releaseNamespace }}
        {{- template "pvTemplate" $item }}
      {{- end }}
    {{- end }}


    {{- if .fileShares }}
      {{- $fileShareStorageClass := .fileShares.storageClass | default "azurefile-csi" }}
      {{- $releaseNamespace := $.Release.Namespace }}
      {{- range .fileShares.items }}
        {{- $item := dict "name" (print $.Values.name "-" $storageName "-" .name "-pv") "storageClassName" $fileShareStorageClass "type" "azurefile" "containerName" .name "secretName" $secretName "releaseNamespace" $releaseNamespace }}
        {{- template "pvTemplate" $item }}
      {{- end }}
    {{- end }}

  {{- end }}
{{- end }}

{{- if .Values.persistence.enabled }}
{{- range .Values.persistence.storages }}
  {{- $storageName := .name }}

  {{- if .containers }}
    {{- $containerStorageClass := .containers.storageClass | default "azureblob-fuse-premium" }}
    {{- range .containers.items }}
      {{- $item := dict "resourceName" (print $.Values.name "-" $storageName "-" .name "-pvc") "storageSize" "100Gi" "volumeResourceName" (print $.Values.name "-" $storageName "-" .name "-pv") "storageClassName" $containerStorageClass }}
      {{- template "pvcTemplate" $item }}
    {{- end }}
  {{- end}}

  {{- if .fileShares }}
    {{- $fileShareStorageClass := .fileShares.storageClass | default "azurefile-csi" }}
    {{- range .fileShares.items }}
      {{- $item := dict "resourceName" (print $.Values.name "-" $storageName "-" .name "-pvc") "storageSize" "5Gi" "volumeResourceName" (print $.Values.name "-" $storageName "-" .name "-pv") "storageClassName" $fileShareStorageClass }}
      {{- template "pvcTemplate" $item }}
    {{- end }}
  {{- end }}

{{- end }}
{{- end }}